# Malware Execution Runbook
**File:** `/SOC-Runbook-Library/02_Incident-Response/Malware-Execution_Runbook.md`  
**Author:** Javon McCloud  
**Maintainer:** McCloudSrAI  
**Version:** 1.0  
**MITRE ID(s):** T1059 (Command and Scripting Interpreter), T1204 (User Execution)  
**Framework:** NIST SP 800-61 (Detection → Containment → Eradication → Recovery)

---

## 1️⃣ Scenario
Microsoft Defender for Endpoint or Sentinel detects suspicious command-line activity (PowerShell or cmd.exe) with encoded/obfuscated payloads or known malicious indicators executing on a workstation/server. Possible indicators include Base64 in command lines, execution from non-standard folders, or callbacks to C2.

---

## 2️⃣ Detection Source
- Microsoft Defender for Endpoint (alerts, isolation capability)  
- Sentinel tables: `DeviceProcessEvents`, `SecurityAlert`, `DeviceNetworkEvents`, `DeviceFileEvents`  
- (Optional) Sysmon Event logs captured in Sentinel (`Sysmon`/`ProcessCreate`)

---

## 3️⃣ Triage Steps
- Review initial alert JSON in Sentinel and note entities (Device, Account, Process, InitiatingProcess).  
- Confirm whether the process is living (still running) and if the device is reachable.  
- Collect artifacts: process command line, parent process, SHA256, file path, child processes, network connections.

KQL examples for triage (run in Sentinel):
```
DeviceProcessEvents
| where FileName in~ ("powershell.exe","pwsh.exe","cmd.exe","cscript.exe","wscript.exe")
| where ProcessCommandLine contains "Base64" or ProcessCommandLine contains "encodedCommand" or ProcessCommandLine contains "IEX" or ProcessCommandLine contains "DownloadString"
| project TimeGenerated, DeviceName, InitiatingProcessFileName, InitiatingProcessCommandLine, ProcessCommandLine, ReportId, InitiatingProcessAccountName
| sort by TimeGenerated desc
```

To enrich:
- Lookup SHA256 against Defender/VT.
- Query `DeviceNetworkEvents` for outbound C2 connections by `ReportId`.
- Check `DeviceFileEvents` for write/modify around the same timestamp.

---

## 4️⃣ Containment
Actions to take immediately (prioritize in order of impact and business needs):

1. **Isolate host** in Defender for Endpoint (prevent lateral spread / network C2).
2. **Suspend the account(s)** used for execution if evidence suggests credential misuse.
3. **Block malicious IPs/domains** observed in `DeviceNetworkEvents` at network perimeter/IDS/Firewall.
4. **Prevent process spawn** via EDR remediation (kill process, remove scheduled tasks).

Short checklist (Tier 1 → Tier 2):
- Tier 1: Confirm alert, isolate host, capture memory snapshot (if available), escalate.  
- Tier 2: Coordinate with patch/infra teams for reimage or deeper forensics.

---

## 5️⃣ Eradication & Recovery
- Remove persistence (scheduled tasks, services, Run keys, WMI persistence).  
- Delete malicious binaries (ensure copies retained in evidence repo).  
- If possible, **reimage** the host from a known-good baseline. If not, perform thorough remediation: AV clean + patching + credential rotation for impacted accounts.  
- Validate system integrity and run full AV/EDR scan post-remediation.

Recovery checklist:
- Restore from backup if integrity cannot be guaranteed.  
- Rotate credentials for any account used on the host.  
- Monitor the device for 30 days for recurrence (in Sentinel hunts).

---

## 6️⃣ Documentation & Escalation
- Create/attach an incident ticket including: alert JSON, KQL query outputs, timeline, SHA256 hashes, network IOCs, screenshots.  
- Tag incident severity (e.g., High/Medium/Low) and assign owner.  
- Escalate to Threat Hunting/IR team if: lateral movement is detected, sensitive data access observed, or multiple hosts compromised.

Evidence to collect:
- `DeviceProcessEvents` export, `DeviceNetworkEvents` export, and memory image (if forensics required).

---

## 7️⃣ Automation Potential
- **Logic App Playbook:** Triggered by Sentinel analytic rule → auto-isolate device, create incident in ticketing system, post summary to SOC Teams channel.  
- **PowerShell Remediation Script:** Remote execution to collect EDR snapshot, disable scheduled task, and remove known malicious files (run only after approval).  
- **Function App:** Automatic IOC enrichment (VirusTotal, Microsoft TI) and IOC insertion into blocking lists.

---

## 8️⃣ Post-Incident Lessons & Tuning
- Add or tune detections for observed command-line patterns and parent/child process combos.  
- Create hunting query for similar patterns across the estate.  
- Roll out defensive rules: block common malicious scripts via AppLocker/WDAC where appropriate.

---

